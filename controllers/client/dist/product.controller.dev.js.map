{"version":3,"sources":["product.controller.js"],"names":["Product","require","ProductCategory","module","exports","index","req","res","find","status","deleted","sort","position","products","item","priceNew","price","discountPercentage","toFixed","render","pageTitle","category","slugCategory","params","findOne","slug","getSubCategory","parent_id","allSubs","select","listSub","sub","id","childs","concat","listSubCategory","listIdSubCategory","map","product_category_id","$in","title","detail","product","_id","redirect"],"mappings":"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","sourcesContent":["const Product = require(\"../../models/product.model\");\nconst ProductCategory = require(\"../../models/product-category.model\");\n\n// [GET] /products/\nmodule.exports.index = async (req, res) => {\n  const products = await Product\n    .find({\n      status: \"active\",\n      deleted: false\n    })\n    .sort({ position: \"desc\" });\n\n  for (const item of products) {\n    item.priceNew = (item.price * (100 - item.discountPercentage)/100).toFixed(0);\n  }\n  \n  res.render(\"client/pages/products/index\", {\n    pageTitle: \"Danh sách sản phẩm\",\n    products: products\n  });\n}\n\n// [GET] /products/:slugCategory\nmodule.exports.category = async (req, res) => {\n  const slugCategory = req.params.slugCategory;\n\n  const category = await ProductCategory.findOne({\n    slug: slugCategory,\n    deleted: false,\n    status: \"active\"\n  });\n\n  const getSubCategory = async (parent_id) => {\n    let allSubs = [];\n\n    const listSub = await ProductCategory.find({\n      parent_id: parent_id,\n      deleted: false,\n      status: \"active\"\n    }).select(\"id title\");\n\n    allSubs = [...listSub];\n\n    for (const sub of listSub) {\n      const childs = await getSubCategory(sub.id);\n      allSubs = allSubs.concat(childs);\n    }\n\n    return allSubs;\n  };\n\n  const listSubCategory = await getSubCategory(category.id);\n  const listIdSubCategory = listSubCategory.map(item => item.id);\n\n  const products = await Product.find({\n    product_category_id: { $in: [category.id, ...listIdSubCategory] },\n    deleted: false,\n    status: \"active\"\n  }).sort({ position: \"desc\" });\n\n  for (const item of products) {\n    item.priceNew = (item.price * (100 - item.discountPercentage)/100).toFixed(0);\n  }\n  \n  res.render(\"client/pages/products/index\", {\n    pageTitle: category.title,\n    products: products\n  });\n}\n\n// [GET] /products/detail/:slug\nmodule.exports.detail = async (req, res) => {\n  const slug = req.params.slug;\n\n  const product = await Product.findOne({\n    slug: slug,\n    deleted: false,\n    status: \"active\"\n  });\n  \n  if(product){\n    const category = await ProductCategory.findOne({\n      _id: product.product_category_id,\n      deleted: false,\n      status: \"active\"\n    });\n    \n    product.category = category;\n    product.priceNew = (product.price * (100 - product.discountPercentage) / 100).toFixed(0);\n\n\n    res.render(\"client/pages/products/detail\", {\n      pageTitle: product.title,\n      product: product\n    });\n  } else {\n    res.redirect(\"/\");\n  }\n}"],"file":"product.controller.dev.js"}