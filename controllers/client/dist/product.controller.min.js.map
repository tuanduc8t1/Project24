{"version":3,"sources":["product.controller.js"],"names":["Product","require","ProductCategory","module","exports","index","req","res","products","_iteratorNormalCompletion","_didIteratorError","_iteratorError","_iterator","_step","item","regeneratorRuntime","async","_context","prev","next","awrap","find","status","deleted","position","sent","undefined","Symbol","iterator","done","value","priceNew","price","discountPercentage","toFixed","t0","finish","render","pageTitle","stop","category","slugCategory","getSubCategory","listSubCategory","listIdSubCategory","_iteratorNormalCompletion3","_didIteratorError3","_iteratorError3","_iterator3","_step3","_context3","params","findOne","parent_id","allSubs","listSub","_iteratorNormalCompletion2","_didIteratorError2","_iteratorError2","_iterator2","_step2","sub","childs","_context2","_toConsumableArray","id","concat","abrupt","map","product_category_id","$in","sort","title","detail","slug","product","_context4","_id","redirect"],"mappings":"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","file":"product.controller.min.js","sourcesContent":["const Product = require(\"../../models/product.model\");\nconst ProductCategory = require(\"../../models/product-category.model\");\n\n// [GET] /products/\nmodule.exports.index = async (req, res) => {\n  const products = await Product\n    .find({\n      status: \"active\",\n      deleted: false\n    })\n    .sort({ position: \"desc\" });\n\n  for (const item of products) {\n    item.priceNew = (item.price * (100 - item.discountPercentage)/100).toFixed(0);\n  }\n  \n  res.render(\"client/pages/products/index\", {\n    pageTitle: \"Danh sách sản phẩm\",\n    products: products\n  });\n}\n\n// [GET] /products/:slugCategory\nmodule.exports.category = async (req, res) => {\n  const slugCategory = req.params.slugCategory;\n\n  const category = await ProductCategory.findOne({\n    slug: slugCategory,\n    deleted: false,\n    status: \"active\"\n  });\n\n  const getSubCategory = async (parent_id) => {\n    let allSubs = [];\n\n    const listSub = await ProductCategory.find({\n      parent_id: parent_id,\n      deleted: false,\n      status: \"active\"\n    }).select(\"id title\");\n\n    allSubs = [...listSub];\n\n    for (const sub of listSub) {\n      const childs = await getSubCategory(sub.id);\n      allSubs = allSubs.concat(childs);\n    }\n\n    return allSubs;\n  };\n\n  const listSubCategory = await getSubCategory(category.id);\n  const listIdSubCategory = listSubCategory.map(item => item.id);\n\n  const products = await Product.find({\n    product_category_id: { $in: [category.id, ...listIdSubCategory] },\n    deleted: false,\n    status: \"active\"\n  }).sort({ position: \"desc\" });\n\n  for (const item of products) {\n    item.priceNew = (item.price * (100 - item.discountPercentage)/100).toFixed(0);\n  }\n  \n  res.render(\"client/pages/products/index\", {\n    pageTitle: category.title,\n    products: products\n  });\n}\n\n// [GET] /products/detail/:slug\nmodule.exports.detail = async (req, res) => {\n  const slug = req.params.slug;\n\n  const product = await Product.findOne({\n    slug: slug,\n    deleted: false,\n    status: \"active\"\n  });\n  \n  if(product){\n    const category = await ProductCategory.findOne({\n      _id: product.product_category_id,\n      deleted: false,\n      status: \"active\"\n    });\n    \n    product.category = category;\n    product.priceNew = (product.price * (100 - product.discountPercentage) / 100).toFixed(0);\n\n\n    res.render(\"client/pages/products/detail\", {\n      pageTitle: product.title,\n      product: product\n    });\n  } else {\n    res.redirect(\"/\");\n  }\n}"]}